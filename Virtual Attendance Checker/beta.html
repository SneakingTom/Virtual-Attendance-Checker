<html>
    <head>
    </head>
    <body>
        <select id="sections" onchange="switchSection()">
            <option value="12-ICT">12-ICT</option>
            <!--<option value="IVOS">IV of Spades</option>-->
        </select>
        <button onclick="addSection()">Add Section</button>
        <button onclick="addStudent()">Add Student</button>

        <table border="1" id="tableBody">
            <thead>
                <th>Name</th>
                <th>Grade & Section/Strand</th>
                <th>Date</th>
                <th>Attendance</th>
                <th>Absences</th>
                <th>Lates</th>
                <th>Status</th>
                <th>Qualified for Perfect Attendance</th>
                <th>Actions</th>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="exportCSV()">Export Attendance</button>
    </body>
</html>
<script>
    let today = new Date();
    let currentDate = (today.getMonth() + 1) + '/' + today.getDate() + '/' + today.getFullYear();
    let sectionsCSV = {
        "12-ICT": [
            {name: "Adinep, Crisjhondie", stdsection: "12-ICT", date: currentDate, attendance: "Present", absences: "0", lates: "1", status: "None", qualification: "Yes" },
            {name: "Libra, Richard", stdsection: "12-ICT", date: currentDate, attendance: "Present", absences: "39", lates: "0", status: "Under Sanctions", qualification: "No" }
        ],
        /**"IVOS": [
            {name: "Silonga, Blaster", stdsection: "IVOS", date: currentDate, attendance: "Present", absences: "0", lates: "0", status: "None", qualification: "Yes" },
            {name: "Salonga, Unique", stdsection: "IVOS", date: currentDate, attendance: "Absent", absences: "40", lates: "0", status: "Dropped Out", qualification: "No" }
        ]**/
    };

    function defaultSections(){
        return {
            "12-ICT": [
                {name: "Adinep, Crisjhondie", stdsection: "12-ICT", date: currentDate, attendance: "Present", absences: "0", lates: "1", status: "None", qualification: "Yes" },
                {name: "Libra, Richard", stdsection: "12-ICT", date: currentDate, attendance: "Present", absences: "39", lates: "0", status: "Under Sanctions", qualification: "No" }
            ],
            /**"IVOS": [
                {name: "Silonga, Blaster", stdsection: "IVOS", date: currentDate, attendance: "Present", absences: "0", lates: "0", status: "None", qualification: "Yes" },
                {name: "Salonga, Unique", stdsection: "IVOS", date: currentDate, attendance: "Absent", absences: "40", lates: "0", status: "Dropped Out", qualification: "No" }
            ]**/
        };
    }

    function saveData(){
        localStorage.setItem("sectionsCSV", JSON.stringify(sectionsCSV));
    }

    function loadData(){
        let sectionsData = localStorage.getItem("sectionsCSV");
        if(sectionsData){
            try{
                let data = JSON.parse(sectionsData);
                if (typeof data == "object" && data != null){
                    sectionsCSV = data;
                    console.log("Loaded Data:", sectionsCSV);
                } else {
                    throw new Error("Invalid format.");
                }
            } catch (error){
                alert("Error loading data:", error);
                sectionsCSV = defaultSections();
            }
        } else {
            console.log("No save data found, using default data.");
            sectionsCSV = defaultSections();
        }
        updateSectionList();
    }

    function switchSection() {
    let section = document.getElementById("sections").value;
    let tableBody = document.getElementById("tableBody").getElementsByTagName("tbody")[0];
    tableBody.innerHTML = "";

    sectionsCSV[section].forEach((student, index) => {
        let row = tableBody.insertRow();
        row.innerHTML = `
            <td>${student.name}</td>
            <td>${student.stdsection}</td>
            <td>${student.date}</td>
            <td>
                <select onchange="updateAttendance('${section}', ${index}, this.value)">
                    <option value="Present" ${student.attendance === "Present" ? "selected" : ""}>Present</option>
                    <option value="Absent" ${student.attendance === "Absent" ? "selected" : ""}>Absent</option>
                    <option value="Late" ${student.attendance === "Late" ? "selected" : ""}>Late</option>
                </select>
            </td>
            <td>${student.absences}</td>
            <td>${student.lates != undefined ? student.lates: "0"}</td>
            <td>${student.status != undefined ? student.status: "None"}</td>
            <td>${student.qualification}</td>
            <td>
                <button onclick="editStudent('${section}', ${index})">Edit</button>
                <button onclick="deleteStudent('${section}', ${index})">Delete</button>
            </td>
        `;
    });
}
window.onload = function() {
    let dropdown = document.getElementById("sections");

    // If no section exists, create a default one
    if (Object.keys(sectionsCSV).length === 0) {
        sectionsCSV["Default Section"] = [];
        let newOption = document.createElement("option");
        newOption.value = "Default Section";
        newOption.textContent = "Default Section";
        dropdown.appendChild(newOption);
    }

    // Set the dropdown to the first section and display data
    dropdown.value = Object.keys(sectionsCSV)[0];
    loadData();
    switchSection();
};

function addSection(){
    let sectionName = prompt("Enter section name:");
    if(sectionName == ""){
        alert("Please enter a valid name");
        return;
    }
    if (sectionsCSV.hasOwnProperty(sectionName)){
        alert("Section already exists");
        return;
    }

    sectionsCSV[sectionName] = [];

    saveData();
    updateSectionList();
    switchSection();
}

function updateSectionList(){
    let dropdown = document.getElementById("sections");
    dropdown.innerHTML = "";

    for(let section in sectionsCSV){
        let option = document.createElement("option");
        option.value = section;
        option.textContent = section;
        dropdown.appendChild(option);
    }
}

function addStudent() {
    let section = document.getElementById("sections").value;
    let name = prompt("Enter student name:");
    //let stdsection = prompt("Enter student section:");
    if (!name) return;

    let newStudent = {
        name: name,
        stdsection: section,
        date: currentDate,
        absences: 0,
        lates: 0,
        status: "None",
        qualification: "Yes"
    };

    sectionsCSV[section].push(newStudent);
    saveData();
    switchSection();
}

function checkQualification(){
    Object.values(sectionsCSV).forEach(students => {
        students.forEach(student => {
            if(parseInt(student.absences) > 0){
                student.qualification = "No";
            } else {
                student.qualification = "Yes";
            }
        });
    });
}

function checkStatus(section, index, newStatus){
    Object.values(sectionsCSV).forEach(students => {
        students.forEach(student => {
            if(parseInt(student.absences) >= 40){
                student.status = "Dropped Out";
            } else if (parseInt(student.absences) >= 20 || parseInt(student.lates) >= 15) {
                student.status = "Under Sanctions";
            } else {
                student.status = "None";
            }
        });
    });
}

function detectLates(){
    Object.values(sectionsCSV).forEach(students => {
        students.forEach(student => {
            let calculatedAbsences = Math.floor(student.lates / 3);
            student.absences = parseInt(student.absences) || 0;
            if(calculatedAbsences > (student.calculatedAbsences || 0)){
                student.absences += (calculatedAbsences - (student.calculatedAbsences || 0));
            }
            student.calculatedAbsences = calculatedAbsences;
            checkQualification();
        });
    });
}

function editStudent(section, index) {
    let newName = prompt("Edit name:", sectionsCSV[section][index].name);
    let newAbsences = prompt("Edit Absences:", sectionsCSV[section][index].absences);
    let newLates = prompt("Edit lates:", sectionsCSV[section][index].lates);
    if (newName) {
        sectionsCSV[section][index].name = newName;
    }
    if (newAbsences){
        sectionsCSV[section][index].absences = newAbsences;
        checkQualification();
        checkStatus();
    }
    if (newLates){
        sectionsCSV[section][index].lates = newLates;
        detectLates();
        checkStatus();
    }

    saveData();
    switchSection();
}

function updateAttendance(section, index, newAttendance){
    sectionsCSV[section][index].attendance = newAttendance;
    let student = sectionsCSV[section][index];
    if (newAttendance == "Absent"){
            student.absences = parseInt(student.absences) || 0;
            student.absences += 1;
            checkQualification();
            checkStatus();
    }
    if (newAttendance == "Late"){
        student.lates = parseInt(student.lates) || 0;
        student.lates += 1;
        detectLates();
        checkStatus();
    }
    saveData();
    switchSection();
}
function deleteStudent(section, index) {
    if (confirm("Are you sure you want to delete this student?")) {
        sectionsCSV[section].splice(index, 1);
        saveData();
        switchSection();
    }
}
function exportCSV() {
    let section = document.getElementById("sections").value;
    let csvContent = "ID,Name,Status\n" + 
        sectionsCSV[section].map(s => `${s.id},${s.name},${s.status}`).join("\n");

    let blob = new Blob([csvContent], { type: "text/csv" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${section}-Attendance.csv`;
    link.click();
}
</script>
